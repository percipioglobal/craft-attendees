{# @var craft \craft\web\twig\variables\CraftVariable #}
{#
/**
 * craft-attendees plugin for Craft CMS 3.x
 *
 * craft-attendees index.twig
 *
 * @author    Percipio.London
 * @copyright Copyright (c) 2021 Percipio.London
 * @link      https://percipio.london
 * @package   Craftattendees
 * @since     0.1.0
 */
#}

{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% do view.registerAssetBundle("percipiolondon\\craftattendees\\assetbundles\\craftattendees\\CraftattendeesAsset") %}
{% do view.registerAssetBundle("percipiolondon\\craftattendees\\assetbundles\\trainingscpsection\\TrainingsCPSectionAsset") %}

{# Link for the ? icon at the bottom of the page #}
{% set docsUrl = "https://github.com/percipioglobal/craft-attendees/blob/master/README.md" %}

{# The title of this CP section #}
{% set title = "Trainings" %}

{# The URL to this plugin's base CP section #}
{% set pluginCpUrl = url('craft-attendees') %}

{# Get a URL to an image in our AssetBundle #}
{% set iconUrl = view.getAssetManager().getPublishedUrl('@percipiolondon/craftattendees/assetbundles/trainingscpsection/dist', true) ~ '/img/Trainings-icon.svg' %}

{% set subnav = {
    "dashboard": { label: "Dashboard"|t('craft-attendees'), url: url(pluginCpUrl ~ '/dashboard') },
    "trainings": { label: "Trainings"|t('craft-attendees'), url: url(pluginCpUrl ~ '/trainings') },
    "data-export": { label: "DataExport"|t('craft-attendees'), url: url(pluginCpUrl ~ '/data-export') },

} %}
{% set selectedSubnavItem = 'trainings' %}
{% set selectedSite = craft.app.request.getQueryParam('site')|default('main') %}

{% set crumbs = [
    { label: "Attendees", url: url(pluginCpUrl) },
    { label: "Trainings"|t('craft-attendees'), url: url(pluginCpUrl ~ '/trainings') },
] %}

{% set settings = craft.app.getPlugins().getPlugin('craft-attendees').getSettings() %}

{# Content that should appear in the page header#}
{% block actionButton %}
    {% include "rsn-data/_includes/sites-menu" with {
        baseUrl: pluginCpUrl ~ '/' ~ selectedSubnavItem,
        currentSiteId: currentSite.id,
        currentSiteHandle: currentSite.handle,
        currentSiteName:  currentSite.name
    } %}
{% endblock %}

{% set events = craft.entries.section(settings.eventSection)
    .site(selectedSite)
    .anyStatus()
    .all()
%}

{# The content of the CP Section#}
{% set content %}

    <div class="tableview tablepane">
        <table class="data fullwidth">
            <thead>
            <tr>
                <th scope="col" data-attribute="title" class="orderable" style="width:35%">Training</th>
                <th scope="col" data-attribute="category" class="orderable">Type</th>
                <th scope="col" data-attribute="eventDate" class="ordered desc">Event Date</th>
                <th scope="col" data-attribute="attendees" class="orderable">Attendees</th>
                <th scope="col" data-attribute="engagement" class="orderable">Engagement</th>
            </tr>
            </thead>
            <tbody>

                {% for event in events %}

                    {% if event.type == 'onlineEvent' %}
                        {% set eventTimetable = event.eventDatesTimeOnline.inReverse().one() %}
                    {% else %}
                        {% set eventTimetable = event.eventDatesTime.inReverse().one() %}
                    {% endif %}

                    {% set eventDate = eventTimetable.startDateTime ?? '' %}
                    {% if eventDate %}
                        {% set eventDate = eventTimetable.startDateTime|date('d/n/Y') %}
                    {% endif %}

                    {% set dataEngagement = null %}
                    {% set dataEnganged = 0 %}
                    {% set dataSustained = 0 %}
                    {% set dataEmbedded = 0 %}

                    <tr data-id="{{ event.id }}" tabindex="0">
                        <td data-title="{{event.slug }} " data-titlecell="">
                            <div class="element small hasstatus"
                                 data-type="craft\elements\Entry"
                                 data-id="{{ event.id }}"
                                 data-status="{{  event.enabled ? 'enabled' : 'disabled' }}"
                                 data-label="{{ event.title }}"
                                 data-url="{{ event.url }}"
                                 title="{{ event.title }}">
                                <span class="status {{ event.enabled ? 'enabled' : 'disabled' }}"></span>
                                <div class="label">
                                    <span class="title">
                                        <a href="/cp/entries/pages/{{event.id}}-events?site={{selectedSite}}#tab-data-engagement">{{ event.title }}</a>
                                    </span>
                                </div>
                            </div>
                        </td>

                        <td data-titleType>
                            {% set categoryName = event.eventCategories.one().title ?? null %}
                            <span>{{- categoryName -}}</span>
                            <span>CategoryName</span>
                        </td>
                        <td data-title="date" data-attr="date">
                            <span>{{ eventDate }} </span>
                        </td>
                        <td data-title="Attendees">
                            <span>{{ dataEngagement|length }} </span>
                        </td>
                        <td>
            {#                <div class="progress">#}
            {#                    <div class="meter bg-red" title="Engaged {{ dataEnganged }}%">#}
            {#                        <span style="width: {{ dataEnganged }}%"></span>#}
            {#                    </div>#}
            {#                    <div class="meter bg-orange" title="Sustained {{ dataSustained }}%">#}
            {#                        <span style="width: {{ dataSustained }}%"></span>#}
            {#                    </div>#}
            {#                    <div class="meter bg-blue" title="Embedded {{ dataEmbedded }}%">#}
            {#                        <span style="width: {{ dataEmbedded }}%"></span>#}
            {#                    </div>#}
            {#                </div>#}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

{#    {{ dump(craft.attendees()) }}#}


{#    <h2>{{ "Trainings CP Section body goes here"|t('craft-attendees') }}</h2>#}
{#    <img src="{{ iconUrl }}" height="64" width="64" />#}
{#    <p class="textline"></p>#}
{% endset %}
